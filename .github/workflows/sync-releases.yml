name: Sync Releases to Downloads

on:
  repository_dispatch:
    types: [silicon-released, intel-released, windows-released]
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to sync (e.g., v1.0.0)'
        required: true
      platform:
        description: 'Platform to sync (silicon, intel, windows, or all)'
        required: true
        default: 'all'

jobs:
  sync-downloads:
    name: Sync Release Artifacts
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout fabric-downloads
        uses: actions/checkout@v4
        
      - name: Set Version
        run: |
          if [ "${{ github.event_name }}" = "repository_dispatch" ]; then
            echo "VERSION=${{ github.event.client_payload.version }}" >> $GITHUB_ENV
            echo "PLATFORM=${{ github.event.action }}" >> $GITHUB_ENV
          else
            echo "VERSION=${{ inputs.version }}" >> $GITHUB_ENV
            echo "PLATFORM=${{ inputs.platform }}" >> $GITHUB_ENV
          fi
          
      - name: Download Silicon Build
        if: env.PLATFORM == 'silicon-released' || env.PLATFORM == 'silicon' || env.PLATFORM == 'both' || env.PLATFORM == 'all'
        env:
          GH_TOKEN: ${{ secrets.RELEASE_PAT }}
        run: |
          VERSION="${{ env.VERSION }}"
          mkdir -p macos/silicon
          
          # Download from GitHub release using gh CLI (works with private repos)
          gh release download ${VERSION} \
            --repo Carmel-Labs-Inc/fabric-silicon \
            --pattern "FabricAgent-Silicon-${VERSION}.dmg" \
            --dir macos/silicon
          
          gh release download ${VERSION} \
            --repo Carmel-Labs-Inc/fabric-silicon \
            --pattern "SHA256-Silicon-${VERSION}.txt" \
            --dir macos/silicon
            
      - name: Download Intel Build
        if: env.PLATFORM == 'intel-released' || env.PLATFORM == 'intel' || env.PLATFORM == 'both' || env.PLATFORM == 'all'
        env:
          GH_TOKEN: ${{ secrets.RELEASE_PAT }}
        run: |
          VERSION="${{ env.VERSION }}"
          mkdir -p macos/intel
          
          # Download from GitHub release using gh CLI (works with private repos)
          gh release download ${VERSION} \
            --repo Carmel-Labs-Inc/fabric-intel \
            --pattern "FabricAgent-Intel-${VERSION}.dmg" \
            --dir macos/intel
          
          gh release download ${VERSION} \
            --repo Carmel-Labs-Inc/fabric-intel \
            --pattern "SHA256-Intel-${VERSION}.txt" \
            --dir macos/intel
            
      - name: Download Windows Build
        if: env.PLATFORM == 'windows-released' || env.PLATFORM == 'windows' || env.PLATFORM == 'all'
        env:
          GH_TOKEN: ${{ secrets.RELEASE_PAT }}
        run: |
          VERSION="${{ env.VERSION }}"
          mkdir -p windows
          
          # Download from GitHub release using gh CLI (works with private repos)
          gh release download ${VERSION} \
            --repo Carmel-Labs-Inc/fabric-windows \
            --pattern "FabricAgent-Windows-${VERSION}.zip" \
            --dir windows
          
          gh release download ${VERSION} \
            --repo Carmel-Labs-Inc/fabric-windows \
            --pattern "SHA256-Windows-${VERSION}.txt" \
            --dir windows
            
      - name: Update latest.json
        run: |
          VERSION="${{ env.VERSION }}"
          VERSION_NUM="${VERSION#v}"  # Remove 'v' prefix
          
          # Get file sizes
          SILICON_SIZE=$(stat -f%z "macos/silicon/FabricAgent-Silicon-${VERSION}.dmg" 2>/dev/null || echo "0")
          INTEL_SIZE=$(stat -f%z "macos/intel/FabricAgent-Intel-${VERSION}.dmg" 2>/dev/null || echo "0")
          WINDOWS_SIZE=$(stat -c%s "windows/FabricAgent-Windows-${VERSION}.zip" 2>/dev/null || stat -f%z "windows/FabricAgent-Windows-${VERSION}.zip" 2>/dev/null || echo "0")
          
          # Get SHA256
          SILICON_SHA=$(cat "macos/silicon/SHA256-Silicon-${VERSION}.txt" | awk '{print $1}' 2>/dev/null || echo "")
          INTEL_SHA=$(cat "macos/intel/SHA256-Intel-${VERSION}.txt" | awk '{print $1}' 2>/dev/null || echo "")
          WINDOWS_SHA=$(cat "windows/SHA256-Windows-${VERSION}.txt" | awk 'NR==2 {print $2}' 2>/dev/null || echo "")
          
          # Update latest.json
          cat > latest.json << EOF
          {
            "version": "${VERSION_NUM}",
            "release_date": "$(date -u +%Y-%m-%d)",
            "platforms": {
              "macos_silicon": {
                "version": "${VERSION_NUM}",
                "download_url": "https://github.com/Carmel-Labs-Inc/fabric-downloads/releases/download/${VERSION}/FabricAgent-Silicon-${VERSION}.dmg",
                "sha256": "${SILICON_SHA}",
                "size_bytes": ${SILICON_SIZE},
                "min_os_version": "12.0"
              },
              "macos_intel": {
                "version": "${VERSION_NUM}",
                "download_url": "https://github.com/Carmel-Labs-Inc/fabric-downloads/releases/download/${VERSION}/FabricAgent-Intel-${VERSION}.dmg",
                "sha256": "${INTEL_SHA}",
                "size_bytes": ${INTEL_SIZE},
                "min_os_version": "12.0"
              },
              "windows": {
                "version": "${VERSION_NUM}",
                "download_url": "https://github.com/Carmel-Labs-Inc/fabric-downloads/releases/download/${VERSION}/FabricAgent-Windows-${VERSION}.zip",
                "sha256": "${WINDOWS_SHA}",
                "size_bytes": ${WINDOWS_SIZE},
                "min_os_version": "10.0"
              }
            },
            "release_notes": "https://github.com/Carmel-Labs-Inc/fabric-silicon/releases/tag/${VERSION}",
            "changelog": [
              "${VERSION} - Production release",
              "- 28 fully implemented workloads (Compute, Data, Media, Inference, Training)",
              "- WebSocket real-time job notifications",
              "- Proof of Execution with privacy protection",
              "- Automatic model cache cleanup",
              "- Background daemon mode"
            ]
          }
          EOF
          
      - name: Commit and Push
        run: |
          VERSION="${{ env.VERSION }}"
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add latest.json
          git commit -m "Update latest.json for ${VERSION}"
          git push
          
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ env.VERSION }}
          name: Fabric Agent ${{ env.VERSION }}
          body: |
            ## Fabric Agent ${{ env.VERSION }}
            
            Production-ready builds for macOS and Windows
            
            ### Downloads
            - **macOS Silicon (M1/M2/M3/M4)**: FabricAgent-Silicon-${{ env.VERSION }}.dmg
            - **macOS Intel (x86_64)**: FabricAgent-Intel-${{ env.VERSION }}.dmg
            - **Windows 10/11 (x86_64)**: FabricAgent-Windows-${{ env.VERSION }}.zip
            
            ### Installation
            
            **macOS:**
            1. Download the appropriate DMG for your Mac
            2. Open the DMG and drag FabricAgent to Applications
            3. Open and follow enrollment instructions
            
            **Windows:**
            1. Download the ZIP file
            2. Extract to a folder
            3. Run FabricAgent.exe and follow enrollment instructions
            
            ### Support
            - Discord: https://discord.gg/fabric
            - Email: support@fabric.carmel.so
          files: |
            macos/silicon/FabricAgent-Silicon-*.dmg
            macos/silicon/SHA256-Silicon-*.txt
            macos/intel/FabricAgent-Intel-*.dmg
            macos/intel/SHA256-Intel-*.txt
            windows/FabricAgent-Windows-*.zip
            windows/SHA256-Windows-*.txt
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

