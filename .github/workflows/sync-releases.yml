name: Sync Releases to Downloads

on:
  repository_dispatch:
    types: [silicon-released, intel-released, windows-released, linux-released]
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to sync (e.g., v1.0.0)'
        required: true
      platform:
        description: 'Platform to sync (silicon, intel, windows, or all)'
        required: true
        default: 'all'

jobs:
  sync-downloads:
    name: Sync Release Artifacts
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout fabric-downloads
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.RELEASE_PAT }}
        
      - name: Set Version
        run: |
          if [ "${{ github.event_name }}" = "repository_dispatch" ]; then
            echo "VERSION=${{ github.event.client_payload.version }}" >> $GITHUB_ENV
            echo "PLATFORM=${{ github.event.action }}" >> $GITHUB_ENV
          else
            echo "VERSION=${{ inputs.version }}" >> $GITHUB_ENV
            echo "PLATFORM=${{ inputs.platform }}" >> $GITHUB_ENV
          fi
          
      - name: Download Silicon Build
        if: env.PLATFORM == 'silicon-released' || env.PLATFORM == 'silicon' || env.PLATFORM == 'both' || env.PLATFORM == 'all'
        env:
          GH_TOKEN: ${{ secrets.RELEASE_PAT }}
        run: |
          VERSION="${{ env.VERSION }}"
          mkdir -p macos/silicon
          
          # Download from GitHub release using gh CLI (works with private repos)
          gh release download ${VERSION} \
            --repo Carmel-Labs-Inc/fabric-silicon \
            --pattern "FabricAgent-Silicon-${VERSION}.dmg" \
            --dir macos/silicon
          
          gh release download ${VERSION} \
            --repo Carmel-Labs-Inc/fabric-silicon \
            --pattern "SHA256-Silicon-${VERSION}.txt" \
            --dir macos/silicon
            
      - name: Download Intel Build
        if: env.PLATFORM == 'intel-released' || env.PLATFORM == 'intel' || env.PLATFORM == 'both' || env.PLATFORM == 'all'
        env:
          GH_TOKEN: ${{ secrets.RELEASE_PAT }}
        run: |
          VERSION="${{ env.VERSION }}"
          mkdir -p macos/intel
          
          # Download from GitHub release using gh CLI (works with private repos)
          gh release download ${VERSION} \
            --repo Carmel-Labs-Inc/fabric-intel \
            --pattern "FabricAgent-Intel-${VERSION}.dmg" \
            --dir macos/intel
          
          gh release download ${VERSION} \
            --repo Carmel-Labs-Inc/fabric-intel \
            --pattern "SHA256-Intel-${VERSION}.txt" \
            --dir macos/intel
            
      - name: Download Windows Build
        if: env.PLATFORM == 'windows-released' || env.PLATFORM == 'windows' || env.PLATFORM == 'all'
        env:
          GH_TOKEN: ${{ secrets.RELEASE_PAT }}
        run: |
          VERSION="${{ env.VERSION }}"
          # Extract version number (remove windows-v prefix)
          VERSION_NUM="${VERSION#windows-v}"
          VERSION_NUM="${VERSION_NUM#v}"
          mkdir -p windows
          
          # Download ZIP from GitHub release
          gh release download ${VERSION} \
            --repo Carmel-Labs-Inc/fabric-windows \
            --pattern "FabricAgent-Windows-${VERSION}.zip" \
            --dir windows
          
          # Download Installer (FabricAgentSetup-X.X.X.exe)
          gh release download ${VERSION} \
            --repo Carmel-Labs-Inc/fabric-windows \
            --pattern "FabricAgentSetup-${VERSION_NUM}.exe" \
            --dir windows || echo "Installer not found, continuing..."
          
          # Download checksums
          gh release download ${VERSION} \
            --repo Carmel-Labs-Inc/fabric-windows \
            --pattern "SHA256-Windows-${VERSION}.txt" \
            --dir windows
          
          # List downloaded files
          ls -la windows/
          
      - name: Download Linux Build
        if: env.PLATFORM == 'linux-released' || env.PLATFORM == 'linux' || env.PLATFORM == 'all'
        env:
          GH_TOKEN: ${{ secrets.RELEASE_PAT }}
        run: |
          VERSION="${{ env.VERSION }}"
          mkdir -p linux
          
          # Download x86_64 AppImage
          gh release download ${VERSION} \
            --repo Carmel-Labs-Inc/fabric-linux \
            --pattern "FabricAgent-Linux-x86_64-${VERSION}.AppImage" \
            --dir linux || echo "x86_64 AppImage not found"
          
          # Download aarch64 binary
          gh release download ${VERSION} \
            --repo Carmel-Labs-Inc/fabric-linux \
            --pattern "FabricAgent-Linux-aarch64-${VERSION}" \
            --dir linux || echo "aarch64 binary not found"
          
          # Download checksums
          gh release download ${VERSION} \
            --repo Carmel-Labs-Inc/fabric-linux \
            --pattern "SHA256-Linux-*" \
            --dir linux || echo "Checksums not found"
          
          # List downloaded files
          ls -la linux/
            
      - name: Update latest.json
        run: |
          VERSION="${{ env.VERSION }}"
          PLATFORM="${{ env.PLATFORM }}"
          
          # Install jq for JSON manipulation
          sudo apt-get install -y jq
          
          # Only update the specific platform that was released
          if [[ "$PLATFORM" == "silicon-released" || "$PLATFORM" == "silicon" ]]; then
            SHA=$(cat "macos/silicon/SHA256-Silicon-${VERSION}.txt" 2>/dev/null | awk '{print $1}' || echo "")
            SIZE=$(stat -c%s "macos/silicon/FabricAgent-Silicon-${VERSION}.dmg" 2>/dev/null || echo "0")
            
            jq --arg ver "$VERSION" \
               --arg url "https://github.com/Carmel-Labs-Inc/fabric-downloads/releases/download/${VERSION}/FabricAgent-Silicon-${VERSION}.dmg" \
               --arg sha "$SHA" \
               --argjson size "$SIZE" \
               '.platforms.macos_silicon.version = $ver | 
                .platforms.macos_silicon.download_url = $url | 
                .platforms.macos_silicon.sha256 = $sha | 
                .platforms.macos_silicon.size_bytes = $size |
                .release_date = (now | strftime("%Y-%m-%d"))' latest.json > latest.json.tmp && mv latest.json.tmp latest.json
                
          elif [[ "$PLATFORM" == "intel-released" || "$PLATFORM" == "intel" ]]; then
            SHA=$(cat "macos/intel/SHA256-Intel-${VERSION}.txt" 2>/dev/null | awk '{print $1}' || echo "")
            SIZE=$(stat -c%s "macos/intel/FabricAgent-Intel-${VERSION}.dmg" 2>/dev/null || echo "0")
            
            jq --arg ver "$VERSION" \
               --arg url "https://github.com/Carmel-Labs-Inc/fabric-downloads/releases/download/${VERSION}/FabricAgent-Intel-${VERSION}.dmg" \
               --arg sha "$SHA" \
               --argjson size "$SIZE" \
               '.platforms.macos_intel.version = $ver | 
                .platforms.macos_intel.download_url = $url | 
                .platforms.macos_intel.sha256 = $sha | 
                .platforms.macos_intel.size_bytes = $size |
                .release_date = (now | strftime("%Y-%m-%d"))' latest.json > latest.json.tmp && mv latest.json.tmp latest.json
                
          elif [[ "$PLATFORM" == "windows-released" || "$PLATFORM" == "windows" ]]; then
            SHA=$(cat "windows/SHA256-Windows-${VERSION}.txt" 2>/dev/null | awk 'NR==2 {print $2}' || echo "")
            SIZE=$(stat -c%s "windows/FabricAgent-Windows-${VERSION}.zip" 2>/dev/null || echo "0")
            VERSION_NUM="${VERSION#windows-v}"
            VERSION_NUM="${VERSION_NUM#v}"
            
            jq --arg ver "$VERSION" \
               --arg url "https://github.com/Carmel-Labs-Inc/fabric-downloads/releases/download/${VERSION}/FabricAgentSetup-${VERSION_NUM}.exe" \
               --arg installer "https://github.com/Carmel-Labs-Inc/fabric-downloads/releases/download/${VERSION}/FabricAgentSetup-${VERSION_NUM}.exe" \
               --arg zip "https://github.com/Carmel-Labs-Inc/fabric-downloads/releases/download/${VERSION}/FabricAgent-Windows-${VERSION}.zip" \
               --arg sha "$SHA" \
               --argjson size "$SIZE" \
               '.platforms.windows.version = $ver | 
                .platforms.windows.download_url = $url | 
                .platforms.windows.installer_url = $installer |
                .platforms.windows.zip_url = $zip |
                .platforms.windows.sha256 = $sha | 
                .platforms.windows.size_bytes = $size |
                .release_date = (now | strftime("%Y-%m-%d"))' latest.json > latest.json.tmp && mv latest.json.tmp latest.json
                
          elif [[ "$PLATFORM" == "linux-released" || "$PLATFORM" == "linux" ]]; then
            SHA_X86=$(cat "linux/SHA256-Linux-x86_64-${VERSION}.txt" 2>/dev/null | awk '{print $1}' || echo "")
            SHA_ARM=$(cat "linux/SHA256-Linux-aarch64-${VERSION}.txt" 2>/dev/null | awk '{print $1}' || echo "")
            SIZE_X86=$(stat -c%s "linux/FabricAgent-Linux-x86_64-${VERSION}.AppImage" 2>/dev/null || echo "0")
            SIZE_ARM=$(stat -c%s "linux/FabricAgent-Linux-aarch64-${VERSION}" 2>/dev/null || echo "0")
            
            jq --arg ver "$VERSION" \
               --arg url_x86 "https://github.com/Carmel-Labs-Inc/fabric-downloads/releases/download/${VERSION}/FabricAgent-Linux-x86_64-${VERSION}.AppImage" \
               --arg url_arm "https://github.com/Carmel-Labs-Inc/fabric-downloads/releases/download/${VERSION}/FabricAgent-Linux-aarch64-${VERSION}" \
               --arg sha_x86 "$SHA_X86" \
               --arg sha_arm "$SHA_ARM" \
               --argjson size_x86 "$SIZE_X86" \
               --argjson size_arm "$SIZE_ARM" \
               '.platforms.linux_x86_64.version = $ver | 
                .platforms.linux_x86_64.download_url = $url_x86 | 
                .platforms.linux_x86_64.sha256 = $sha_x86 | 
                .platforms.linux_x86_64.size_bytes = $size_x86 |
                .platforms.linux_aarch64.version = $ver | 
                .platforms.linux_aarch64.download_url = $url_arm | 
                .platforms.linux_aarch64.sha256 = $sha_arm | 
                .platforms.linux_aarch64.size_bytes = $size_arm |
                .release_date = (now | strftime("%Y-%m-%d"))' latest.json > latest.json.tmp && mv latest.json.tmp latest.json
          fi
          
          echo "Updated latest.json for $PLATFORM"
          cat latest.json
          
      - name: Commit and Push
        run: |
          VERSION="${{ env.VERSION }}"
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add latest.json
          git commit -m "Update latest.json for ${VERSION}"
          git push
          
      - name: Create GitHub Release (Silicon)
        if: env.PLATFORM == 'silicon-released' || env.PLATFORM == 'silicon'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ env.VERSION }}
          name: Fabric Agent ${{ env.VERSION }}
          body: |
            ## Fabric Agent ${{ env.VERSION }}
            
            macOS Silicon (M1/M2/M3/M4) build
          files: |
            macos/silicon/FabricAgent-Silicon-*.dmg
            macos/silicon/SHA256-Silicon-*.txt
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Notify Silicon Users
        if: env.PLATFORM == 'silicon-released' || env.PLATFORM == 'silicon'
        run: |
          VERSION="${{ env.VERSION }}"
          VERSION_NUM="${VERSION#silicon-v}"
          VERSION_NUM="${VERSION_NUM#v}"
          
          curl -X POST "https://api.fabric.carmel.so/api/admin/notify-agent-update" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${{ secrets.CRON_SECRET }}" \
            -d "{
              \"platform\": \"silicon\",
              \"version\": \"${VERSION_NUM}\",
              \"message\": \"New macOS Silicon agent available\"
            }" || echo "Notification failed, continuing..."
          
      - name: Create GitHub Release (Intel)
        if: env.PLATFORM == 'intel-released' || env.PLATFORM == 'intel'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ env.VERSION }}
          name: Fabric Agent ${{ env.VERSION }}
          body: |
            ## Fabric Agent ${{ env.VERSION }}
            
            macOS Intel (x86_64) build
          files: |
            macos/intel/FabricAgent-Intel-*.dmg
            macos/intel/SHA256-Intel-*.txt
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Notify Intel Users
        if: env.PLATFORM == 'intel-released' || env.PLATFORM == 'intel'
        run: |
          VERSION="${{ env.VERSION }}"
          VERSION_NUM="${VERSION#intel-v}"
          VERSION_NUM="${VERSION_NUM#v}"
          
          curl -X POST "https://api.fabric.carmel.so/api/admin/notify-agent-update" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${{ secrets.CRON_SECRET }}" \
            -d "{
              \"platform\": \"intel\",
              \"version\": \"${VERSION_NUM}\",
              \"message\": \"New macOS Intel agent available\"
            }" || echo "Notification failed, continuing..."
          
      - name: Create GitHub Release (Windows)
        if: env.PLATFORM == 'windows-released' || env.PLATFORM == 'windows'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ env.VERSION }}
          name: Fabric Agent ${{ env.VERSION }}
          body: |
            ## Fabric Agent ${{ env.VERSION }}
            
            Windows 10/11 (x86_64) build
          files: |
            windows/FabricAgentSetup-*.exe
            windows/FabricAgent-Windows-*.zip
            windows/SHA256-Windows-*.txt
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Notify Windows Users
        if: env.PLATFORM == 'windows-released' || env.PLATFORM == 'windows'
        run: |
          VERSION="${{ env.VERSION }}"
          VERSION_NUM="${VERSION#windows-v}"
          VERSION_NUM="${VERSION_NUM#v}"
          
          curl -X POST "https://api.fabric.carmel.so/api/admin/notify-agent-update" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${{ secrets.CRON_SECRET }}" \
            -d "{
              \"platform\": \"windows\",
              \"version\": \"${VERSION_NUM}\",
              \"message\": \"New Windows agent available\"
            }" || echo "Notification failed, continuing..."
          
      - name: Create GitHub Release (Linux)
        if: env.PLATFORM == 'linux-released' || env.PLATFORM == 'linux'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ env.VERSION }}
          name: Fabric Agent ${{ env.VERSION }}
          body: |
            ## Fabric Agent ${{ env.VERSION }}
            
            Linux builds:
            - **x86_64 (Intel/AMD)**: AppImage format
            - **aarch64 (ARM64)**: Binary format
          files: |
            linux/FabricAgent-Linux-x86_64-*.AppImage
            linux/FabricAgent-Linux-aarch64-*
            linux/SHA256-Linux-*.txt
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Notify Linux Users
        if: env.PLATFORM == 'linux-released' || env.PLATFORM == 'linux'
        run: |
          VERSION="${{ env.VERSION }}"
          VERSION_NUM="${VERSION#linux-v}"
          VERSION_NUM="${VERSION_NUM#v}"
          
          curl -X POST "https://api.fabric.carmel.so/api/admin/notify-agent-update" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${{ secrets.CRON_SECRET }}" \
            -d "{
              \"platform\": \"linux\",
              \"version\": \"${VERSION_NUM}\",
              \"message\": \"New Linux agent available\"
            }" || echo "Notification failed, continuing..."

